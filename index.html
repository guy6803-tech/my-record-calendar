<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ë‚˜ì˜ ê¸°ë¡ ìº˜ë¦°ë” ğŸŒ¿</title>

<!-- âœ… Spoqa Han Sans Neo (ë‹¨ì •í•œ í†¤) -->
<link rel="stylesheet" href="https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css">

<style>
  * { box-sizing: border-box; }

  body {
    font-family: 'Spoqa Han Sans Neo', 'Pretendard', sans-serif;
    background: #f5f6f7;
    color: #333;
    margin: 0;
    padding: 2rem;
    display: flex;
    justify-content: center;
    letter-spacing: -0.2px;
  }

  .calendar-container {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 1.5rem;
    width: 880px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    overflow: hidden;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  #monthLabel {
    margin: 0;
    font-size: 1.25rem;
  }

  .nav button {
    border: 1px solid #ccc;
    background: #f8f8f8;
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
    transition: 0.2s;
    white-space: nowrap;
    font-family: inherit;
  }
  .nav button:hover { background: #e8f0ed; }

  /* âœ… ê²€ìƒ‰ + ë¡œê·¸ì¸ ì˜ì—­ */
  .search-bar {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
    width: 100%;
  }
  .search-row, .auth-row {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .search-bar input {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.45rem 0.8rem;
    width: 260px;
    max-width: 40vw;
    font-family: inherit;
  }

  .search-bar button {
    background: #465b73;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.45rem 0.9rem;
    cursor: pointer;
    white-space: nowrap;
    font-family: inherit;
  }

  #logoutBtn { background: #888; }

  #authStatus {
    font-size: 12px;
    color: #666;
    margin-left: 4px;
  }

  .weekday-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 700;
    color: #555;
    margin-bottom: 0.3rem;
  }
  .weekday-header div:nth-child(1) { color: #d33; }
  .weekday-header div:nth-child(7) { color: #3366cc; }

  #calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(6, minmax(120px, auto));
    border-top: 1px solid #ddd;
    border-left: 1px solid #ddd;
    background: #fff;
  }

  .day {
    border-right: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    padding: 10px;
    cursor: pointer;
    transition: background 0.2s ease;
    position: relative;
    min-height: 120px;
  }
  .day:hover { background: #f0f5f2; }

  .day-number {
    position: absolute;
    top: 8px;
    left: 8px;
    font-size: 0.95rem;
    font-weight: 700;
  }

  .dot {
    width: 6px;
    height: 6px;
    background: red;
    border-radius: 50%;
    position: absolute;
    top: 10px;
    right: 10px;
  }

  .summary {
    font-size: 0.82rem;
    color: #666;
    margin-top: 28px;
    line-height: 1.35;
    word-break: break-word;
    white-space: pre-wrap;
    width: 100%;
  }

  /* âœ… ë…¸íŠ¸ ì„¹ì…˜ */
  #noteSection {
    display: none;
    flex-direction: column;
    gap: 0.8rem;
    margin-top: 1.2rem;
  }
  #noteSection.active { display: flex; }

  #selectedDate {
    margin: 0.2rem 0 0.2rem;
    font-size: 1.05rem;
    font-weight: 800;
  }

  .note-nav {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .note-nav button {
    border: 1px solid #cfd6d2;
    background: #f4f7f5;
    border-radius: 999px;
    padding: 0.45rem 0.8rem;
    cursor: pointer;
    transition: 0.15s;
    font-size: 0.9rem;
    white-space: nowrap;
    font-family: inherit;
  }
  .note-nav button:hover { background: #e9f1ed; }

  .note-nav .divider {
    width: 1px;
    height: 26px;
    background: #e2e6e4;
    margin: 0 0.2rem;
  }

  textarea {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #d5d5d5;
    padding: 1rem;
    resize: none;
    background: #fff;
    outline: none;
    font-family: inherit;
    line-height: 1.6;
  }

  #noteArea { height: 260px; font-size: 1rem; }
  #summaryInput { height: 70px; font-size: 0.95rem; background: #fafafa; }

  /* âœ… ë…¸ì…˜ ëŠë‚Œ URL "ë©˜ì…˜" ì˜ì—­ */
  .mention-area {
    padding: 0.8rem;
    border: 1px solid #e3e3e3;
    background: #fafafa;
    border-radius: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 54px;
  }

  .mention-empty {
    color: #888;
    font-size: 0.9rem;
  }

  .mention-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0.42rem 0.65rem;
    border-radius: 999px;
    border: 1px solid #d7dfdb;
    background: #ffffff;
    color: #2f3b4a;
    text-decoration: none;
    font-size: 0.9rem;
    max-width: 100%;
  }

  .mention-chip:hover { background: #eef4f1; }

  .mention-chip .chip-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 520px;
  }

  .bottom-controls {
    display: flex;
    justify-content: space-between;
    margin-top: 0.4rem;
  }

  .bottom-controls button {
    background: #e7ece9;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0.6rem 1rem;
    cursor: pointer;
    font-family: inherit;
  }

  /* âœ… ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 640px) {
    body {
      padding: 12px;
      padding-top: calc(12px + env(safe-area-inset-top));
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .calendar-container { width: 100%; padding: 1rem; }
    header { flex-direction: column; align-items: stretch; }
    .nav { justify-content: space-between; }
    #monthLabel { font-size: 1.1rem; text-align: center; flex: 1; }
    .search-row, .auth-row { width: 100%; justify-content: flex-end; }
    .search-bar input { width: 100%; max-width: 100%; font-size: 16px; }
    #calendar { grid-template-rows: repeat(6, minmax(86px, auto)); }
    .day { min-height: 86px; padding: 8px; }
    textarea { font-size: 16px; }
    #noteArea { height: 40vh; }
    #summaryInput { height: 12vh; }
    .mention-chip .chip-text { max-width: 240px; }
  }
</style>
</head>

<body>
<div class="calendar-container">
  <header>
    <div class="nav">
      <button id="prevMonth">â—€</button>
      <h2 id="monthLabel">2026ë…„ 1ì›”</h2>
      <button id="nextMonth">â–¶</button>
      <button id="todayBtn">ì˜¤ëŠ˜ë¡œ ê°€ê¸°</button>
    </div>

    <!-- âœ… ê²€ìƒ‰ + ë¡œê·¸ì¸(ë™ê¸°í™”) -->
    <div class="search-bar">
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="ì–´ë–¤ ê¸°ì–µì´ ìƒê°ë‚˜ë‚˜ìš”?" />
        <button id="searchBtn">ê²€ìƒ‰</button>
      </div>

      <div class="auth-row">
        <input type="email" id="emailInput" placeholder="ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ (í°/PC ë™ê¸°í™”)" />
        <button id="loginBtn">ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°</button>
        <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="authStatus"></span>
      </div>
    </div>
  </header>

  <div class="weekday-header">
    <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
  </div>

  <div id="calendar"></div>

  <div id="noteSection">
    <h3 id="selectedDate"></h3>

    <div class="note-nav">
      <button id="goWeekAgo">1ì£¼ ì „</button>
      <button id="goMonthAgo">í•œë‹¬ ì „</button>
      <button id="go6MonthsAgo">6ê°œì›” ì „</button>
      <button id="goYearAgo">1ë…„ ì „</button>

      <span class="divider"></span>

      <button id="backToOriginBtn" style="display:none;">ì›ë˜ ê¸€ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <!-- âœ… ë§ì¶¤ë²• ë°‘ì¤„ ì œê±° -->
    <textarea
      id="noteArea"
      placeholder="ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ë³´ì„¸ìš”."
      spellcheck="false"
      autocapitalize="off"
      autocomplete="off"
      autocorrect="off"></textarea>

    <textarea
      id="summaryInput"
      placeholder="í•œì¤„í‰ì„ ë‚¨ê²¨ë³´ì„¸ìš”."
      spellcheck="false"
      autocapitalize="off"
      autocomplete="off"
      autocorrect="off"></textarea>

    <!-- âœ… URL ë©˜ì…˜(ë§í¬ ì¹©) -->
    <div id="mentionArea" class="mention-area"></div>

    <div class="bottom-controls">
      <button id="backButton">â† ë‹¬ë ¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // âœ… Supabase ì„¤ì • (ë„ˆê°€ ì¤€ ê°’ ê³ ì •)
  const SUPABASE_URL = "https://sjhtpbvzugvzuvgsrezv.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_F3fswXMzGjypezsUYmLg9g_dLsBGhqI";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const calendar = document.getElementById('calendar');
  const noteSection = document.getElementById('noteSection');
  const noteArea = document.getElementById('noteArea');
  const summaryInput = document.getElementById('summaryInput');
  const selectedDateEl = document.getElementById('selectedDate');
  const headerLabel = document.getElementById('monthLabel');

  const backButton = document.getElementById('backButton');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  const todayBtn = document.getElementById('todayBtn');

  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');

  const goWeekAgo = document.getElementById('goWeekAgo');
  const goMonthAgo = document.getElementById('goMonthAgo');
  const go6MonthsAgo = document.getElementById('go6MonthsAgo');
  const goYearAgo = document.getElementById('goYearAgo');
  const backToOriginBtn = document.getElementById('backToOriginBtn');

  const mentionArea = document.getElementById('mentionArea');

  // âœ… Auth UI
  const emailInput = document.getElementById('emailInput');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authStatus = document.getElementById('authStatus');

  let current = new Date();

  // âœ… "ì›ë˜ ì‘ì„±í•˜ë˜ ê¸€" ê¸°ì¤€ ë‚ ì§œ(ê³ ì •)
  let originDate = null;

  // âœ… ì§€ê¸ˆ í™”ë©´ì—ì„œ ë³´ê³  ìˆëŠ” ë‚ ì§œ(ì´ë™ ë²„íŠ¼ìœ¼ë¡œ ë°”ë€” ìˆ˜ ìˆìŒ)
  let viewDate = null;

  // âœ… ë¡œê·¸ì¸ ìœ ì € / ì €ì¥ debounce
  let authedUser = null;
  let saveTimer = null;

  function normalizeDate(d) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  // âœ… íƒ€ì„ì¡´ ì´ìŠˆ ë°©ì§€ (YYYY-MM-DD ê³ ì •)
  function dateKey(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  // âœ… localStorage ì•ˆì „ íŒŒì‹±
  function safeLoad(key) {
    const raw = localStorage.getItem(key);
    if (!raw) return {};
    try {
      const parsed = JSON.parse(raw);
      return (parsed && typeof parsed === 'object') ? parsed : {};
    } catch (e) {
      return { memo: raw, summary: '' };
    }
  }

  /* =========================
     âœ… ë…¸ì…˜ ëŠë‚Œ URL "ë©˜ì…˜" ì²˜ë¦¬
  ========================== */
  function extractUrls(text) {
    const matches = String(text || '').match(/https?:\/\/[^\s]+/g);
    if (!matches) return [];

    const cleaned = matches
      .map(u => u.replace(/[),.]+$/g, ''))
      .filter(Boolean);

    return Array.from(new Set(cleaned)).slice(0, 20);
  }

  function makeChipLabel(url) {
    try {
      const u = new URL(url);
      const path = u.pathname && u.pathname !== '/' ? u.pathname : '';
      const shortPath = path.length > 24 ? path.slice(0, 24) + 'â€¦' : path;
      return `${u.hostname}${shortPath}`;
    } catch {
      return url.length > 40 ? url.slice(0, 40) + 'â€¦' : url;
    }
  }

  function updateMentionsFromText(text) {
    const urls = extractUrls(text);
    mentionArea.innerHTML = '';

    if (urls.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'mention-empty';
      empty.textContent = 'ë©”ëª¨ì— URLì„ ë¶™ì—¬ë„£ìœ¼ë©´ ì—¬ê¸°ì— ë§í¬ê°€ í‘œì‹œë¼ìš”.';
      mentionArea.appendChild(empty);
      return;
    }

    urls.forEach(url => {
      const a = document.createElement('a');
      a.className = 'mention-chip';
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.title = url;

      const icon = document.createElement('span');
      icon.textContent = 'ğŸ”—';

      const textEl = document.createElement('span');
      textEl.className = 'chip-text';
      textEl.textContent = makeChipLabel(url);

      a.appendChild(icon);
      a.appendChild(textEl);
      mentionArea.appendChild(a);
    });
  }

  /* =========================
     âœ… Supabase ë™ê¸°í™”
  ========================== */
  async function refreshAuthUI() {
    const { data } = await supabase.auth.getSession();
    authedUser = data?.session?.user ?? null;

    if (authedUser) {
      authStatus.textContent = `ë™ê¸°í™”: ë¡œê·¸ì¸ë¨ (${authedUser.email})`;
      loginBtn.style.display = 'none';
      emailInput.style.display = 'none';
      logoutBtn.style.display = 'inline-flex';

      await syncMonthToLocal(current.getFullYear(), current.getMonth());
      renderCalendar();
    } else {
      authStatus.textContent = 'ë™ê¸°í™”: ë¡œì»¬ ì €ì¥ì¤‘ (ë¡œê·¸ì¸í•˜ë©´ í°/PC ê³µìœ )';
      loginBtn.style.display = 'inline-flex';
      emailInput.style.display = 'inline-flex';
      logoutBtn.style.display = 'none';
    }
  }

  loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');

    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: window.location.origin }
    });

    if (error) return alert(error.message);
    alert('ë¡œê·¸ì¸ ë§í¬ë¥¼ ì´ë©”ì¼ë¡œ ë³´ëƒˆì–´ìš”. ë©”ì¼ì—ì„œ ë§í¬ë¥¼ ëˆŒëŸ¬ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    await refreshAuthUI();
  };

  supabase.auth.onAuthStateChange(async () => {
    await refreshAuthUI();
  });

  async function fetchEntryFromCloud(key) {
    if (!authedUser) return null;

    const { data, error } = await supabase
      .from('entries')
      .select('memo, summary, updated_at')
      .eq('user_id', authedUser.id)
      .eq('date_key', key)
      .maybeSingle();

    if (error) {
      console.warn('[cloud fetch error]', error.message);
      return null;
    }
    return data;
  }

  async function upsertEntryToCloud(key, memo, summary) {
    if (!authedUser) return;

    const { error } = await supabase
      .from('entries')
      .upsert(
        {
          user_id: authedUser.id,
          date_key: key,
          memo: memo ?? '',
          summary: summary ?? '',
          updated_at: new Date().toISOString(),
        },
        { onConflict: 'user_id,date_key' }
      );

    if (error) console.warn('[cloud upsert error]', error.message);
  }

  async function syncMonthToLocal(year, monthIndex) {
    if (!authedUser) return;

    const start = new Date(year, monthIndex, 1);
    const end = new Date(year, monthIndex + 1, 1);

    const { data, error } = await supabase
      .from('entries')
      .select('date_key, memo, summary, updated_at')
      .eq('user_id', authedUser.id)
      .gte('date_key', dateKey(start))
      .lt('date_key', dateKey(end));

    if (error) {
      console.warn('[cloud month sync error]', error.message);
      return;
    }

    (data || []).forEach(row => {
      localStorage.setItem(row.date_key, JSON.stringify({
        version: 2,
        memo: row.memo || '',
        summary: row.summary || '',
        updatedAt: row.updated_at || ''
      }));
    });
  }

  /* =========================
     âœ… ë‹¬ë ¥ ë Œë”
  ========================== */
  function renderCalendar() {
    calendar.innerHTML = '';
    const year = current.getFullYear();
    const month = current.getMonth();

    headerLabel.textContent = `${year}ë…„ ${month + 1}ì›”`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const totalDays = lastDay.getDate();

    for (let i = 0; i < startDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'day';
      calendar.appendChild(empty);
    }

    for (let d = 1; d <= totalDays; d++) {
      const date = new Date(year, month, d);
      const key = dateKey(date);
      const saved = safeLoad(key);

      const dayEl = document.createElement('div');
      dayEl.className = 'day';

      const num = document.createElement('div');
      num.className = 'day-number';
      num.textContent = d;
      dayEl.appendChild(num);

      if (saved.memo && String(saved.memo).trim()) {
        const dot = document.createElement('div');
        dot.classList.add('dot');
        dayEl.appendChild(dot);
      }

      if (saved.summary && String(saved.summary).trim()) {
        const summary = document.createElement('div');
        summary.className = 'summary';
        summary.textContent = saved.summary;
        dayEl.appendChild(summary);
      }

      dayEl.onclick = () => { openNote(date, { setOrigin: true }); };
      calendar.appendChild(dayEl);
    }

    while (calendar.children.length < 42) {
      const filler = document.createElement('div');
      filler.className = 'day';
      calendar.appendChild(filler);
    }
  }

  function updateBackToOriginVisibility() {
    if (!originDate || !viewDate) {
      backToOriginBtn.style.display = 'none';
      return;
    }
    const isDifferent = dateKey(originDate) !== dateKey(viewDate);
    backToOriginBtn.style.display = isDifferent ? 'inline-flex' : 'none';
  }

  function bindAutosaveHandlers(key) {
    const onInput = () => {
      const data = { version: 1, memo: noteArea.value, summary: summaryInput.value };
      localStorage.setItem(key, JSON.stringify(data));
      renderCalendar();
      updateMentionsFromText(noteArea.value);

      // âœ… ë¡œê·¸ì¸ ìƒíƒœë©´ í´ë¼ìš°ë“œì—ë„ ì €ì¥(ë””ë°”ìš´ìŠ¤)
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        upsertEntryToCloud(key, noteArea.value, summaryInput.value);
      }, 400);
    };
    noteArea.oninput = onInput;
    summaryInput.oninput = onInput;
  }

  async function openNote(date, { setOrigin } = { setOrigin: false }) {
    const normalized = normalizeDate(date);

    if (setOrigin) originDate = normalized;
    viewDate = normalized;

    current = new Date(viewDate);

    const key = dateKey(viewDate);

    // âœ… ë¡œì»¬ ë¨¼ì € í‘œì‹œ
    const saved = safeLoad(key);
    selectedDateEl.textContent = `${key}ì˜ ê¸°ë¡`;
    noteArea.value = saved.memo || '';
    summaryInput.value = saved.summary || '';

    // âœ… ë¡œê·¸ì¸ ìƒíƒœë©´ í´ë¼ìš°ë“œê°€ ìš°ì„ 
    const cloud = await fetchEntryFromCloud(key);
    if (cloud) {
      noteArea.value = cloud.memo || '';
      summaryInput.value = cloud.summary || '';
      localStorage.setItem(key, JSON.stringify({
        version: 2,
        memo: noteArea.value,
        summary: summaryInput.value,
        updatedAt: cloud.updated_at || ''
      }));
      renderCalendar();
    }

    updateMentionsFromText(noteArea.value);

    noteSection.classList.add('active');
    calendar.style.display = 'none';

    bindAutosaveHandlers(key);
    updateBackToOriginVisibility();
  }

  // âœ… ì´ë™ ë²„íŠ¼ì€ "í•­ìƒ originDate ê¸°ì¤€" (ëˆ„ì  ì´ë™ ë°©ì§€)
  function jumpFromOrigin({ days = 0, months = 0, years = 0 }) {
    if (!originDate) return;

    const d = new Date(originDate);
    if (years) d.setFullYear(d.getFullYear() + years);
    if (months) d.setMonth(d.getMonth() + months);
    if (days) d.setDate(d.getDate() + days);

    openNote(d, { setOrigin: false });
  }

  goWeekAgo.onclick = () => jumpFromOrigin({ days: -7 });
  goMonthAgo.onclick = () => jumpFromOrigin({ months: -1 });
  go6MonthsAgo.onclick = () => jumpFromOrigin({ months: -6 });
  goYearAgo.onclick = () => jumpFromOrigin({ years: -1 });

  backToOriginBtn.onclick = () => {
    if (!originDate) return;
    openNote(originDate, { setOrigin: false });
  };

  backButton.onclick = () => {
    noteSection.classList.remove('active');
    calendar.style.display = 'grid';
    renderCalendar();
  };

  prevMonthBtn.onclick = async () => {
    current.setMonth(current.getMonth() - 1);
    await syncMonthToLocal(current.getFullYear(), current.getMonth());
    renderCalendar();
  };

  nextMonthBtn.onclick = async () => {
    current.setMonth(current.getMonth() + 1);
    await syncMonthToLocal(current.getFullYear(), current.getMonth());
    renderCalendar();
  };

  todayBtn.onclick = async () => {
    current = new Date();
    await syncMonthToLocal(current.getFullYear(), current.getMonth());
    renderCalendar();
  };

  searchBtn.onclick = () => {
    const keyword = searchInput.value.trim();
    if (!keyword) return alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

    let found = null;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!/^\d{4}-\d{2}-\d{2}$/.test(key)) continue;

      const saved = safeLoad(key);
      const memo = String(saved.memo || '');
      const summary = String(saved.summary || '');
      if (memo.includes(keyword) || summary.includes(keyword)) {
        found = key;
        break;
      }
    }

    if (!found) return alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');

    const [y, m, d] = found.split('-');
    const target = new Date(Number(y), Number(m) - 1, Number(d));
    current = new Date(target);
    renderCalendar();
    alert(`${found}ì— "${keyword}"ê°€ í¬í•¨ëœ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.`);
  };

  // âœ… ì‹œì‘
  await refreshAuthUI();
  renderCalendar();
</script>
</body>
</html>

